
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../../../assets/images/icon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Troubleshooting - onETL Docs</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/autodoc_pydantic.css">
    
      <link rel="stylesheet" href="../../../../assets/mkdocs_puml/puml.css">
    
      <link rel="stylesheet" href="../../../../assets/mkdocs_puml/interaction.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#spark-s3-troubleshooting" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="onETL Docs" class="md-header__button md-logo" aria-label="onETL Docs" data-md-component="logo">
      
  <img src="../../../../assets/images/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            onETL Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Troubleshooting
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="/en/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/ru/" hreflang="ru" class="md-select__link">
              Русский
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="onETL Docs" class="md-nav__button md-logo" aria-label="onETL Docs" data-md-component="logo">
      
  <img src="../../../../assets/images/logo.svg" alt="logo">

    </a>
    onETL Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../concepts" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../quickstart" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../logging" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Logging
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../contributing" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../changelog/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    changelog
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            changelog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.13.4" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.13.4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.13.3" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.13.3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.13.1" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.13.1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.13.0" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.13.0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.12.5" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.12.5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.12.4" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.12.4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.12.3" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.12.3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.12.2" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.12.2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.12.1" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.12.1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.12.0" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.12.0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.11.2" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.11.2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.11.1" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.11.1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.11.0" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.11.0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.10.2" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.10.2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.10.1" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.10.1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.10.0" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.10.0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.9.5" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.9.5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.9.4" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.9.4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.9.3" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.9.3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.9.2" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.9.2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.9.1" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.9.1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.9.0" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.9.0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.8.1" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.8.1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.8.0" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.8.0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.7.2" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.7.2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.7.1" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.7.1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/0.7.0" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.7.0
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../db_/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    DB
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            DB
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db_/reader" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DBReader
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db_/writer" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DBWriter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#sparks3check-and-other-methods-hang" class="md-nav__link">
    <span class="md-ellipsis">
      SparkS3.check() and other methods hang
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SparkS3.check() and other methods hang">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#details" class="md-nav__link">
    <span class="md-ellipsis">
      Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-determine-reason" class="md-nav__link">
    <span class="md-ellipsis">
      How to determine reason
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How to determine reason">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make-logging-more-verbose" class="md-nav__link">
    <span class="md-ellipsis">
      Make logging more verbose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-number-of-retries" class="md-nav__link">
    <span class="md-ellipsis">
      Change number of retries
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#most-common-mistakes" class="md-nav__link">
    <span class="md-ellipsis">
      Most common mistakes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Most common mistakes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#no-network-access" class="md-nav__link">
    <span class="md-ellipsis">
      No network access
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-https-protocol-for-http-port" class="md-nav__link">
    <span class="md-ellipsis">
      Using HTTPS protocol for HTTP port
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssl-certificate-is-self-signed" class="md-nav__link">
    <span class="md-ellipsis">
      SSL certificate is self-signed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-s3-without-domain-style-access-style-support" class="md-nav__link">
    <span class="md-ellipsis">
      Accessing S3 without domain-style access style support
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#slow-or-unstable-writing-to-s3" class="md-nav__link">
    <span class="md-ellipsis">
      Slow or unstable writing to S3
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Slow or unstable writing to S3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#file-committer" class="md-nav__link">
    <span class="md-ellipsis">
      file committer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#directory-and-partitioned-committers" class="md-nav__link">
    <span class="md-ellipsis">
      directory and partitioned committers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#magic-committer" class="md-nav__link">
    <span class="md-ellipsis">
      magic committer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#see-also" class="md-nav__link">
    <span class="md-ellipsis">
      See also
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#slow-reading-from-s3" class="md-nav__link">
    <span class="md-ellipsis">
      Slow reading from S3
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<p>(spark-s3-troubleshooting)=</p>
<h1 id="spark-s3-troubleshooting">Spark S3 Troubleshooting<a class="headerlink" href="#spark-s3-troubleshooting" title="Permanent link">&para;</a></h1>
<div class="highlight"><pre><span></span><code>.. note::

    General guide: :ref:`troubleshooting`.
</code></pre></div>
<p>More details:</p>
<ul>
<li><a href="https://hadoop.apache.org/docs/stable/hadoop-aws/tools/hadoop-aws/troubleshooting_s3a.html">Hadoop AWS Troubleshooting Guide</a></li>
<li><a href="https://hadoop.apache.org/docs/stable/hadoop-aws/tools/hadoop-aws/performance.html">Hadoop AWS Performance Guide</a></li>
<li><a href="https://spark.apache.org/docs/latest/cloud-integration.html">Spark integration with Cloud Infrastructures</a></li>
</ul>
<h2 id="sparks3check-and-other-methods-hang"><code>SparkS3.check()</code> and other methods hang<a class="headerlink" href="#sparks3check-and-other-methods-hang" title="Permanent link">&para;</a></h2>
<h3 id="details">Details<a class="headerlink" href="#details" title="Permanent link">&para;</a></h3>
<p>S3 may not respond for connection attempts for a long time if it's under heavy load.
To handle this, Hadoop AWS library has retry mechanism. By default it retries 7 times with 500ms interval.</p>
<p>Hadoop AWS is based on AWS SDK library, which also has retry mechanism. This mechanism is not disabled because it handles different
errors than Hadoop AWS, so they complement each other. Default number of attempts in AWS SDK is 20 with minimal 5s interval,
which is exponentially increasing with each failed attempt.</p>
<p>It is not a problem if S3 source is not accessible at all, like hostname cannot be resolved, or port is not opened.
These errors are not recoverable, and retry mechanism is not activated.</p>
<p>But errors like SSL issues, are considered recoverable, and this causing retry of retry over increasing interval.
So user is waiting for <a href="https://issues.apache.org/jira/browse/HADOOP-18839">almost 15 minutes</a> just to get exception message.</p>
<h3 id="how-to-determine-reason">How to determine reason<a class="headerlink" href="#how-to-determine-reason" title="Permanent link">&para;</a></h3>
<h4 id="make-logging-more-verbose">Make logging more verbose<a class="headerlink" href="#make-logging-more-verbose" title="Permanent link">&para;</a></h4>
<p>Change Spark session log level to {ref}<code>DEBUG &lt;troubleshooting-spark&gt;</code> to print result of each attempt.
Resulting logs will look like this</p>
<div class="highlight"><pre><span></span><code>.. dropdown:: See log

    .. code:: text

        23/08/03 11:25:10 DEBUG S3AFileSystem: Using S3ABlockOutputStream with buffer = disk; block=67108864; queue limit=4
        23/08/03 11:25:10 DEBUG S3Guard: Metastore option source [core-default.xml]
        23/08/03 11:25:10 DEBUG S3Guard: Using NullMetadataStore metadata store for s3a filesystem
        23/08/03 11:25:10 DEBUG S3AFileSystem: S3Guard is disabled on this bucket: test-bucket
        23/08/03 11:25:10 DEBUG DirectoryPolicyImpl: Directory markers will be deleted
        23/08/03 11:25:10 DEBUG S3AFileSystem: Directory marker retention policy is DirectoryMarkerRetention{policy=&#39;delete&#39;}
        23/08/03 11:25:10 DEBUG S3AUtils: Value of fs.s3a.multipart.purge.age is 86400
        23/08/03 11:25:10 DEBUG S3AUtils: Value of fs.s3a.bulk.delete.page.size is 250
        23/08/03 11:25:10 DEBUG FileSystem: Creating FS s3a://test-bucket/fake: duration 0:01.029s
        23/08/03 11:25:10 DEBUG IOStatisticsStoreImpl: Incrementing counter op_is_directory by 1 with final value 1
        23/08/03 11:25:10 DEBUG S3AFileSystem: Getting path status for s3a://test-bucket/fake  (fake); needEmptyDirectory=false
        23/08/03 11:25:10 DEBUG S3AFileSystem: S3GetFileStatus s3a://test-bucket/fake
        23/08/03 11:25:10 DEBUG S3AFileSystem: LIST List test-bucket:/fake/ delimiter=/ keys=2 requester pays=false
        23/08/03 11:25:10 DEBUG S3AFileSystem: Starting: LIST
        23/08/03 11:25:10 DEBUG IOStatisticsStoreImpl: Incrementing counter object_list_request by 1 with final value 1
        23/08/03 11:25:10 DEBUG AWSCredentialProviderList: Using credentials from SimpleAWSCredentialsProvider
        23/08/03 11:25:10 DEBUG request: Sending Request: GET https://test-bucket.localhost:9000 / Parameters: ({&quot;list-type&quot;:[&quot;2&quot;],&quot;delimiter&quot;:[&quot;/&quot;],&quot;max-keys&quot;:[&quot;2&quot;],&quot;prefix&quot;:[&quot;fake/&quot;],&quot;fetch-owner&quot;:[&quot;false&quot;]}Headers: (amz-sdk-invocation-id: e6d62603-96e4-a80f-10a1-816e0822bc71, Content-Type: application/octet-stream, User-Agent: Hadoop 3.3.4, aws-sdk-java/1.12.262 Linux/6.4.7-1-MANJARO OpenJDK_64-Bit_Server_VM/25.292-b10 java/1.8.0_292 scala/2.12.17 vendor/AdoptOpenJDK cfg/retry-mode/legacy, )
        23/08/03 11:25:10 DEBUG AWS4Signer: AWS4 Canonical Request: &#39;&quot;GET
        /
        delimiter=%2F&amp;fetch-owner=false&amp;list-type=2&amp;max-keys=2&amp;prefix=fake%2F
        amz-sdk-invocation-id:e6d62603-96e4-a80f-10a1-816e0822bc71
        amz-sdk-request:attempt=1;max=21
        amz-sdk-retry:0/0/500
        content-type:application/octet-stream
        host:test-bucket.localhost:9000
        user-agent:Hadoop 3.3.4, aws-sdk-java/1.12.262 Linux/6.4.7-1-MANJARO OpenJDK_64-Bit_Server_VM/25.292-b10 java/1.8.0_292 scala/2.12.17 vendor/AdoptOpenJDK cfg/retry-mode/legacy
        x-amz-content-sha256:UNSIGNED-PAYLOAD
        x-amz-date:20230803T112510Z

        amz-sdk-invocation-id;amz-sdk-request;amz-sdk-retry;content-type;host;user-agent;x-amz-content-sha256;x-amz-date
        UNSIGNED-PAYLOAD&quot;
        23/08/03 11:25:10 DEBUG AWS4Signer: AWS4 String to Sign: &#39;&quot;AWS4-HMAC-SHA256
        20230803T112510Z
        20230803/us-east-1/s3/aws4_request
        31a317bb7f6d97248dd0cf03429d701cbb3e29ce889cfbb98ba7a34c57a3bfba&quot;
        23/08/03 11:25:10 DEBUG AWS4Signer: Generating a new signing key as the signing key not available in the cache for the date 1691020800000
        23/08/03 11:25:10 DEBUG RequestAddCookies: CookieSpec selected: default
        23/08/03 11:25:10 DEBUG RequestAuthCache: Auth cache not set in the context
        23/08/03 11:25:10 DEBUG PoolingHttpClientConnectionManager: Connection request: [route: {s}-&gt;https://test-bucket.localhost:9000][total available: 0; route allocated: 0 of 96; total allocated: 0 of 96]
        23/08/03 11:25:10 DEBUG PoolingHttpClientConnectionManager: Connection leased: [id: 0][route: {s}-&gt;https://test-bucket.localhost:9000][total available: 0; route allocated: 1 of 96; total allocated: 1 of 96]
        23/08/03 11:25:10 DEBUG MainClientExec: Opening connection {s}-&gt;https://test-bucket.localhost:9000
        23/08/03 11:25:10 DEBUG DefaultHttpClientConnectionOperator: Connecting to test-bucket.localhost/127.0.0.1:9000
        23/08/03 11:25:10 DEBUG SSLConnectionSocketFactory: Connecting socket to test-bucket.localhost/127.0.0.1:9000 with timeout 5000
        23/08/03 11:25:10 DEBUG SSLConnectionSocketFactory: Enabled protocols: [TLSv1.2]
        23/08/03 11:25:10 DEBUG SSLConnectionSocketFactory: Enabled cipher suites:[TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384, TLS_RSA_WITH_AES_256_CBC_SHA256, TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDH_RSA_WITH_AES_256_CBC_SHA384, TLS_DHE_RSA_WITH_AES_256_CBC_SHA256, TLS_DHE_DSS_WITH_AES_256_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_RSA_WITH_AES_256_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDH_RSA_WITH_AES_256_CBC_SHA, TLS_DHE_RSA_WITH_AES_256_CBC_SHA, TLS_DHE_DSS_WITH_AES_256_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_DSS_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, TLS_EMPTY_RENEGOTIATION_INFO_SCSV]
        23/08/03 11:25:10 DEBUG SSLConnectionSocketFactory: Starting handshake
        23/08/03 11:25:10 DEBUG ClientConnectionManagerFactory:
        java.lang.reflect.InvocationTargetException
                at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
                at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
                at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
                at java.lang.reflect.Method.invoke(Method.java:498)
                at com.amazonaws.http.conn.ClientConnectionManagerFactory$Handler.invoke(ClientConnectionManagerFactory.java:76)
                at com.amazonaws.http.conn.$Proxy32.connect(Unknown Source)
                at com.amazonaws.thirdparty.apache.http.impl.execchain.MainClientExec.establishRoute(MainClientExec.java:393)
                at com.amazonaws.thirdparty.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:236)
                at com.amazonaws.thirdparty.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:186)
                at com.amazonaws.thirdparty.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:185)
                at com.amazonaws.thirdparty.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:83)
                at com.amazonaws.thirdparty.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:56)
                at com.amazonaws.http.apache.client.impl.SdkHttpClient.execute(SdkHttpClient.java:72)
                at com.amazonaws.http.AmazonHttpClient$RequestExecutor.executeOneRequest(AmazonHttpClient.java:1346)
                at com.amazonaws.http.AmazonHttpClient$RequestExecutor.executeHelper(AmazonHttpClient.java:1157)
                at com.amazonaws.http.AmazonHttpClient$RequestExecutor.doExecute(AmazonHttpClient.java:814)
                at com.amazonaws.http.AmazonHttpClient$RequestExecutor.executeWithTimer(AmazonHttpClient.java:781)
                at com.amazonaws.http.AmazonHttpClient$RequestExecutor.execute(AmazonHttpClient.java:755)
                at com.amazonaws.http.AmazonHttpClient$RequestExecutor.access$500(AmazonHttpClient.java:715)
                at com.amazonaws.http.AmazonHttpClient$RequestExecutionBuilderImpl.execute(AmazonHttpClient.java:697)
                at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:561)
                at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:541)
                at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:5456)
                at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:5403)
                at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:5397)
                at com.amazonaws.services.s3.AmazonS3Client.listObjectsV2(AmazonS3Client.java:971)
                at org.apache.hadoop.fs.s3a.S3AFileSystem.lambda$listObjects$11(S3AFileSystem.java:2595)
                at org.apache.hadoop.fs.statistics.impl.IOStatisticsBinding.lambda$trackDurationOfOperation$5(IOStatisticsBinding.java:499)
                at org.apache.hadoop.fs.s3a.Invoker.retryUntranslated(Invoker.java:414)
                at org.apache.hadoop.fs.s3a.Invoker.retryUntranslated(Invoker.java:377)
                at org.apache.hadoop.fs.s3a.S3AFileSystem.listObjects(S3AFileSystem.java:2586)
                at org.apache.hadoop.fs.s3a.S3AFileSystem.s3GetFileStatus(S3AFileSystem.java:3832)
                at org.apache.hadoop.fs.s3a.S3AFileSystem.innerGetFileStatus(S3AFileSystem.java:3688)
                at org.apache.hadoop.fs.s3a.S3AFileSystem.lambda$isDirectory$35(S3AFileSystem.java:4724)
                at org.apache.hadoop.fs.statistics.impl.IOStatisticsBinding.lambda$trackDurationOfOperation$5(IOStatisticsBinding.java:499)
                at org.apache.hadoop.fs.statistics.impl.IOStatisticsBinding.trackDuration(IOStatisticsBinding.java:444)
                at org.apache.hadoop.fs.s3a.S3AFileSystem.trackDurationAndSpan(S3AFileSystem.java:2337)
                at org.apache.hadoop.fs.s3a.S3AFileSystem.trackDurationAndSpan(S3AFileSystem.java:2356)
                at org.apache.hadoop.fs.s3a.S3AFileSystem.isDirectory(S3AFileSystem.java:4722)
                at org.apache.spark.sql.execution.streaming.FileStreamSink$.hasMetadata(FileStreamSink.scala:54)
                at org.apache.spark.sql.execution.datasources.DataSource.resolveRelation(DataSource.scala:366)
                at org.apache.spark.sql.DataFrameReader.loadV1Source(DataFrameReader.scala:229)
                at org.apache.spark.sql.DataFrameReader.$anonfun$load$2(DataFrameReader.scala:211)
                at scala.Option.getOrElse(Option.scala:189)
                at org.apache.spark.sql.DataFrameReader.load(DataFrameReader.scala:211)
                at org.apache.spark.sql.DataFrameReader.load(DataFrameReader.scala:186)
                at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
                at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
                at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
                at java.lang.reflect.Method.invoke(Method.java:498)
                at py4j.reflection.MethodInvoker.invoke(MethodInvoker.java:244)
                at py4j.reflection.ReflectionEngine.invoke(ReflectionEngine.java:374)
                at py4j.Gateway.invoke(Gateway.java:282)
                at py4j.commands.AbstractCommand.invokeMethod(AbstractCommand.java:132)
                at py4j.commands.CallCommand.execute(CallCommand.java:79)
                at py4j.ClientServerConnection.waitForCommands(ClientServerConnection.java:182)
                at py4j.ClientServerConnection.run(ClientServerConnection.java:106)
                at java.lang.Thread.run(Thread.java:748)
        Caused by: javax.net.ssl.SSLException: Unsupported or unrecognized SSL message
                at sun.security.ssl.SSLSocketInputRecord.handleUnknownRecord(SSLSocketInputRecord.java:448)
                at sun.security.ssl.SSLSocketInputRecord.decode(SSLSocketInputRecord.java:184)
                at sun.security.ssl.SSLTransport.decode(SSLTransport.java:109)
                at sun.security.ssl.SSLSocketImpl.decode(SSLSocketImpl.java:1383)
                at sun.security.ssl.SSLSocketImpl.readHandshakeRecord(SSLSocketImpl.java:1291)
                at sun.security.ssl.SSLSocketImpl.startHandshake(SSLSocketImpl.java:435)
                at com.amazonaws.thirdparty.apache.http.conn.ssl.SSLConnectionSocketFactory.createLayeredSocket(SSLConnectionSocketFactory.java:436)
                at com.amazonaws.thirdparty.apache.http.conn.ssl.SSLConnectionSocketFactory.connectSocket(SSLConnectionSocketFactory.java:384)
                at com.amazonaws.thirdparty.apache.http.impl.conn.DefaultHttpClientConnectionOperator.connect(DefaultHttpClientConnectionOperator.java:142)
                at com.amazonaws.thirdparty.apache.http.impl.conn.PoolingHttpClientConnectionManager.connect(PoolingHttpClientConnectionManager.java:376)
                ... 58 more
        23/08/03 11:25:10 DEBUG DefaultManagedHttpClientConnection: http-outgoing-0: Shutdown connection
        23/08/03 11:25:10 DEBUG MainClientExec: Connection discarded
        23/08/03 11:25:10 DEBUG PoolingHttpClientConnectionManager: Connection released: [id: 0][route: {s}-&gt;https://test-bucket.localhost:9000][total available: 0; route allocated: 0 of 96; total allocated: 0 of 96]
        23/08/03 11:25:10 DEBUG AmazonHttpClient: Unable to execute HTTP request: Unsupported or unrecognized SSL message Request will be retried.
        23/08/03 11:25:10 DEBUG request: Retrying Request: GET https://test-bucket.localhost:9000 / Parameters: ({&quot;list-type&quot;:[&quot;2&quot;],&quot;delimiter&quot;:[&quot;/&quot;],&quot;max-keys&quot;:[&quot;2&quot;],&quot;prefix&quot;:[&quot;fake/&quot;],&quot;fetch-owner&quot;:[&quot;false&quot;]}Headers: (amz-sdk-invocation-id: e6d62603-96e4-a80f-10a1-816e0822bc71, Content-Type: application/octet-stream, User-Agent: Hadoop 3.3.4, aws-sdk-java/1.12.262 Linux/6.4.7-1-MANJARO OpenJDK_64-Bit_Server_VM/25.292-b10 java/1.8.0_292 scala/2.12.17 vendor/AdoptOpenJDK cfg/retry-mode/legacy, )
        23/08/03 11:25:10 DEBUG AmazonHttpClient: Retriable error detected, will retry in 49ms, attempt number: 0
</code></pre></div>
<h4 id="change-number-of-retries">Change number of retries<a class="headerlink" href="#change-number-of-retries" title="Permanent link">&para;</a></h4>
<p>You can also change number of retries performed by both libraries using <code>extra</code> parameter:</p>
<div class="highlight"><pre><span></span><code><span class="n">spark_s3</span> <span class="o">=</span> <span class="n">SparkS3</span><span class="p">(</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;attempts.maximum&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;retry.limit&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
</code></pre></div>
<p>So accessing S3 will fail almost immediately if there is any error.</p>
<h3 id="most-common-mistakes">Most common mistakes<a class="headerlink" href="#most-common-mistakes" title="Permanent link">&para;</a></h3>
<h4 id="no-network-access">No network access<a class="headerlink" href="#no-network-access" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Caused by: java.net.ConnectException: Connection refused
</code></pre></div>
<p>Mostly caused by:</p>
<ul>
<li>Trying to access port number which S3 server does not listen</li>
<li>You're trying to access host which is unreachable from your network (e.g. running behind some proxy or VPN)</li>
<li>There are some firewall restrictions for accessing specific host or port</li>
</ul>
<h4 id="using-https-protocol-for-http-port">Using HTTPS protocol for HTTP port<a class="headerlink" href="#using-https-protocol-for-http-port" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Caused by: javax.net.ssl.SSLException: Unsupported or unrecognized SSL message
</code></pre></div>
<p>By default, SparkS3 uses HTTPS protocol for connection.
If you change port number, this does not lead to changing protocol:</p>
<div class="highlight"><pre><span></span><code><span class="n">spark_s3</span> <span class="o">=</span> <span class="n">SparkS3</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;s3provider.com&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</code></pre></div>
<p>You should pass protocol explicitly:</p>
<div class="highlight"><pre><span></span><code><span class="n">spark_s3</span> <span class="o">=</span> <span class="n">SparkS3</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;s3provider.com&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</code></pre></div>
<h4 id="ssl-certificate-is-self-signed">SSL certificate is self-signed<a class="headerlink" href="#ssl-certificate-is-self-signed" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target
</code></pre></div>
<p>To connect to HTTPS port with self-signed certificate, you should
<a href="https://stackoverflow.com/questions/373295/digital-certificate-how-to-import-cer-file-in-to-truststore-file-using">add certificate chain to Java TrustedStore</a>.</p>
<p>Another option is to disable SSL check:</p>
<div class="highlight"><pre><span></span><code><span class="n">spark_s3</span> <span class="o">=</span> <span class="n">SparkS3</span><span class="p">(</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;connection.ssl.enabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
</code></pre></div>
<p>But is is <strong>NOT</strong> recommended.</p>
<h4 id="accessing-s3-without-domain-style-access-style-support">Accessing S3 without domain-style access style support<a class="headerlink" href="#accessing-s3-without-domain-style-access-style-support" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Caused by: java.net.UnknownHostException: my-bucket.s3provider.com
</code></pre></div>
<p>To use path-style access, use option below:</p>
<div class="highlight"><pre><span></span><code><span class="n">spark_s3</span> <span class="o">=</span> <span class="n">SparkS3</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="s2">&quot;s3provider.com&quot;</span><span class="p">,</span>
    <span class="n">bucket</span><span class="o">=</span><span class="s2">&quot;my-bucket&quot;</span><span class="p">,</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;path.style.access&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
</code></pre></div>
<h2 id="slow-or-unstable-writing-to-s3">Slow or unstable writing to S3<a class="headerlink" href="#slow-or-unstable-writing-to-s3" title="Permanent link">&para;</a></h2>
<p>Hadoop AWS allows to use different writing strategies for different S3 implementations, depending
on list of supported features by server.</p>
<p>These strategies are called <a href="https://hadoop.apache.org/docs/stable/hadoop-aws/tools/hadoop-aws/committers.html">committers</a>.
There are <a href="https://hadoop.apache.org/docs/stable/hadoop-aws/tools/hadoop-aws/committers.html#Switching_to_an_S3A_Committer">different types of committers</a>:</p>
<ul>
<li><code>file</code> (default)</li>
<li><code>directory</code></li>
<li><code>partitioned</code></li>
<li><code>magic</code></li>
</ul>
<h3 id="file-committer"><code>file</code> committer<a class="headerlink" href="#file-committer" title="Permanent link">&para;</a></h3>
<p>This committer is quite slow and unstable, so it is not recommended to use:</p>
<div class="highlight"><pre><span></span><code>WARN AbstractS3ACommitterFactory: Using standard FileOutputCommitter to commit work. This is slow and potentially unsafe.
</code></pre></div>
<p>This is caused by the fact it creates files in the temp directory on remote filesystem, and after all of them are written successfully,
they are moved to target directory on same remote filesystem.</p>
<p>This is not an issue for HDFS which does support file move operations and also support renaming directory
as atomic operation with <code>O(1)</code> time complexity.</p>
<p>But S3 does support only file copying, so moving is performed via copy + delete.
Also it does not support atomic directory rename operation. Instead, renaming files with the same prefix has time complexity <code>O(n)</code>.</p>
<h3 id="directory-and-partitioned-committers"><code>directory</code> and <code>partitioned</code> committers<a class="headerlink" href="#directory-and-partitioned-committers" title="Permanent link">&para;</a></h3>
<p>These are <a href="https://hadoop.apache.org/docs/stable/hadoop-aws/tools/hadoop-aws/committer_architecture.html">staging committers</a>,
meaning that they create temp directories on local filesystem, and after all files are written successfully,
they will be uploaded to S3. Local filesystems do support file moving and directory renaming,
so these committers does not have issues that <code>file</code> committer has.</p>
<p>But they both require free space on local filesystem, and this may be an issue if user need to write large amount of data.
Also this can be an issue for container environment, like Kubernetes, there resources should be allocated before starting a container.</p>
<h3 id="magic-committer"><code>magic</code> committer<a class="headerlink" href="#magic-committer" title="Permanent link">&para;</a></h3>
<p>This committer uses multipart upload feature of S3 API, allowing to create multiple files
and after all of them were written successfully finish the transaction. Before transaction is finished,
files will not be accessible by other clients.</p>
<p>Because it does not require neither file moving operations, nor directory atomic rename,
upload process is done in most efficient way S3 support.
This <a href="https://spot.io/blog/improve-apache-spark-performance-with-the-s3-magic-committer/">drastically increases writing performance</a>.</p>
<p>To use this committer, set <a href="https://github.com/apache/spark/pull/32518">following properties</a> while creating Spark session.</p>
<div class="highlight"><pre><span></span><code>.. tabs::

    .. code-tab:: py S3 your main distributed filesystem (Spark on Kubernetes)

        # https://issues.apache.org/jira/browse/SPARK-23977
        # https://spark.apache.org/docs/latest/cloud-integration.html#committing-work-into-cloud-storage-safely-and-fast
        spark = (
            SparkSession.builder.appName(&quot;spark-app-name&quot;)
            .config(&quot;spark.hadoop.fs.s3a.committer.magic.enabled&quot;, &quot;true&quot;)
            .config(&quot;spark.hadoop.fs.s3a.committer.name&quot;, &quot;magic&quot;)
            .config(&quot;spark.hadoop.mapreduce.outputcommitter.factory.scheme.s3a&quot;, &quot;org.apache.hadoop.fs.s3a.commit.S3ACommitterFactory&quot;)
            .config(&quot;spark.sql.parquet.output.committer.class&quot;, &quot;org.apache.spark.internal.io.cloud.BindingParquetOutputCommitter&quot;)
            .config(&quot;spark.sql.sources.commitProtocolClass&quot;, &quot;org.apache.spark.internal.io.cloud.PathOutputCommitProtocol&quot;)
            .getOrCreate()
        )

    .. code-tab:: py HDFS is your main distributed filesystem (Spark on Hadoop)

        # https://community.cloudera.com/t5/Support-Questions/spark-sql-sources-partitionOverwriteMode-dynamic-quot-not/m-p/343483/highlight/true
        spark = (
            SparkSession.builder.appName(&quot;spark-app-name&quot;)
            .config(&quot;spark.hadoop.fs.s3a.committer.magic.enabled&quot;, &quot;true&quot;)
            .config(&quot;spark.hadoop.fs.s3a.committer.name&quot;, &quot;magic&quot;)
            .getOrCreate()
        )
</code></pre></div>
<div class="highlight"><pre><span></span><code>.. warning::

    ``magic`` committer requires S3 implementation to have strong consistency - file upload API return response only
    if it was written on enough number of cluster nodes, and any cluster node error does not lead to missing or corrupting files.

    Some S3 implementations does have strong consistency
    (like `AWS S3 &lt;https://aws.amazon.com/ru/blogs/aws/amazon-s3-update-strong-read-after-write-consistency/&gt;`_ and
    `MinIO &lt;https://blog.min.io/migrating-hdfs-to-object-storage/&gt;`_), some not. Please contact your S3 provider
    to get information about S3 implementation consistency.
</code></pre></div>
<div class="highlight"><pre><span></span><code>.. warning::

    ``magic`` committer does not support ``if_exists=&quot;replace_overlapping_partitions&quot;``.
    Either use another ``if_exists`` value, or use ``partitioned`` committer.
</code></pre></div>
<h3 id="see-also">See also<a class="headerlink" href="#see-also" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://hadoop.apache.org/docs/stable/hadoop-aws/tools/hadoop-aws/directory_markers.html">directory.marker.retention="keep"</a></li>
</ul>
<h2 id="slow-reading-from-s3">Slow reading from S3<a class="headerlink" href="#slow-reading-from-s3" title="Permanent link">&para;</a></h2>
<p>Please read following documentation:</p>
<ul>
<li><a href="https://hadoop.apache.org/docs/stable/hadoop-aws/tools/hadoop-aws/prefetching.html">prefetch.enabled</a></li>
<li><a href="https://hadoop.apache.org/docs/stable/hadoop-aws/tools/hadoop-aws/performance.html#Improving_data_input_performance_through_fadvise">experimental.input.fadvise</a></li>
<li><a href="https://spark.apache.org/docs/latest/cloud-integration.html#parquet-io-settings">Parquet and ORC I/O settings</a></li>
</ul>
<p>If you're reading data from row-based formats, like {ref}<code>csv-file-format</code>, prefer
<a href="https://issues.apache.org/jira/browse/HADOOP-17789?focusedCommentId=17383559#comment-17383559">experimental.input.fadvise="sequential" with increased readahead.range</a>.</p>
<p>But for other file formats, especially using compression, prefer
<a href="https://issues.apache.org/jira/browse/HADOOP-17789?focusedCommentId=17383743#comment-17383743">experimental.input.fadvise="normal"</a></p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.indexes", "content.tabs.link", "content.code.copy", "content.code.select"], "search": "../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../../../../assets/mkdocs_puml/puml.js"></script>
      
        <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
      
        <script src="../../../../assets/mkdocs_puml/interaction.js"></script>
      
    
  </body>
</html>