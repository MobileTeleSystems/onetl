
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../assets/images/icon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Design - onETL Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/autodoc_pydantic.css">
    
      <link rel="stylesheet" href="../../assets/mkdocs_puml/puml.css">
    
      <link rel="stylesheet" href="../../assets/mkdocs_puml/interaction.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#high-level-design" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="onETL Docs" class="md-header__button md-logo" aria-label="onETL Docs" data-md-component="logo">
      
  <img src="../../assets/images/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            onETL Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Design
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="/en/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/ru/" hreflang="ru" class="md-select__link">
              Русский
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="onETL Docs" class="md-nav__button md-logo" aria-label="onETL Docs" data-md-component="logo">
      
  <img src="../../assets/images/logo.svg" alt="logo">

    </a>
    onETL Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logging" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Logging
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../changelog/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    changelog
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            changelog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.13.4" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.13.4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.13.3" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.13.3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.13.1" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.13.1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.13.0" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.13.0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.12.5" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.12.5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.12.4" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.12.4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.12.3" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.12.3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.12.2" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.12.2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.12.1" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.12.1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.12.0" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.12.0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.11.2" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.11.2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.11.1" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.11.1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.11.0" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.11.0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.10.2" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.10.2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.10.1" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.10.1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.10.0" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.10.0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.9.5" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.9.5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.9.4" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.9.4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.9.3" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.9.3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.9.2" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.9.2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.9.1" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.9.1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.9.0" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.9.0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.8.1" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.8.1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.8.0" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.8.0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.7.2" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.7.2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.7.1" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.7.1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/0.7.0" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.7.0
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../db_/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    DB
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            DB
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../db_/reader" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DBReader
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../db_/writer" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DBWriter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-are-hooks" class="md-nav__link">
    <span class="md-ellipsis">
      What are hooks?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="What are hooks?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#features" class="md-nav__link">
    <span class="md-ellipsis">
      Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limitations" class="md-nav__link">
    <span class="md-ellipsis">
      Limitations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terms" class="md-nav__link">
    <span class="md-ellipsis">
      Terms
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-implement-hooks" class="md-nav__link">
    <span class="md-ellipsis">
      How to implement hooks?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How to implement hooks?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tldr" class="md-nav__link">
    <span class="md-ellipsis">
      TL;DR
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TL;DR">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#define-a-slot" class="md-nav__link">
    <span class="md-ellipsis">
      Define a slot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-a-callback" class="md-nav__link">
    <span class="md-ellipsis">
      Define a callback
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-a-hook" class="md-nav__link">
    <span class="md-ellipsis">
      Define a hook
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bind-hook-to-the-slot" class="md-nav__link">
    <span class="md-ellipsis">
      Bind hook to the slot
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-hooks-are-called" class="md-nav__link">
    <span class="md-ellipsis">
      How hooks are called?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How hooks are called?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#general" class="md-nav__link">
    <span class="md-ellipsis">
      General
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#context-managers" class="md-nav__link">
    <span class="md-ellipsis">
      Context managers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generator-function" class="md-nav__link">
    <span class="md-ellipsis">
      Generator function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#calling-hooks-in-details" class="md-nav__link">
    <span class="md-ellipsis">
      Calling hooks in details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hooks-priority" class="md-nav__link">
    <span class="md-ellipsis">
      Hooks priority
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hook-types" class="md-nav__link">
    <span class="md-ellipsis">
      Hook types
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hook types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#before-hook" class="md-nav__link">
    <span class="md-ellipsis">
      Before hook
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#after-hook" class="md-nav__link">
    <span class="md-ellipsis">
      After hook
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#context-hook" class="md-nav__link">
    <span class="md-ellipsis">
      Context hook
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replacing-result-hook" class="md-nav__link">
    <span class="md-ellipsis">
      Replacing result hook
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-result-hook" class="md-nav__link">
    <span class="md-ellipsis">
      Accessing result hook
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modifying-result-hook" class="md-nav__link">
    <span class="md-ellipsis">
      Modifying result hook
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-enabledisable-hooks" class="md-nav__link">
    <span class="md-ellipsis">
      How to enable/disable hooks?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-see-logs-of-the-hook-mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      How to see logs of the hook mechanism?
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<p>(hooks-design)=</p>
<h1 id="high-level-design">High level design<a class="headerlink" href="#high-level-design" title="Permanent link">&para;</a></h1>
<h2 id="what-are-hooks">What are hooks?<a class="headerlink" href="#what-are-hooks" title="Permanent link">&para;</a></h2>
<p>Hook mechanism is a part of onETL which allows to inject some additional behavior into
existing methods of (almost) any class.</p>
<h3 id="features">Features<a class="headerlink" href="#features" title="Permanent link">&para;</a></h3>
<p>Hooks mechanism allows to:</p>
<ul>
<li>Inspect and validate input arguments and output results of method call</li>
<li>Access, modify or replace method call result (but NOT input arguments)</li>
<li>Wrap method calls with a context manager and catch raised exceptions</li>
</ul>
<p>Hooks can be placed into {ref}<code>plugins</code>, allowing to modify onETL behavior by installing some additional package.</p>
<h3 id="limitations">Limitations<a class="headerlink" href="#limitations" title="Permanent link">&para;</a></h3>
<ul>
<li>Hooks can be bound to methods of a class only (not functions).</li>
<li>Only methods decorated with {ref}<code>slot-decorator</code> implement hooks mechanism. These class and methods are marked as {{ support_hooks }}.</li>
<li>Hooks can be bound to public methods only.</li>
</ul>
<h2 id="terms">Terms<a class="headerlink" href="#terms" title="Permanent link">&para;</a></h2>
<ul>
<li>{ref}<code>slot-decorator</code> - method of a class with a special decorator</li>
<li><code>Callback</code> - function which implements some additional logic which modifies slot behavior</li>
<li>{ref}<code>hook-decorator</code> - wrapper around callback which stores hook state, priority and some useful methods</li>
<li><code>Hooks mechanism</code> - calling <code>Slot()</code> will call all enabled hooks which are bound to the slot. Implemented by {ref}<code>support-hooks-decorator</code>.</li>
</ul>
<h2 id="how-to-implement-hooks">How to implement hooks?<a class="headerlink" href="#how-to-implement-hooks" title="Permanent link">&para;</a></h2>
<h3 id="tldr">TL;DR<a class="headerlink" href="#tldr" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">onetl.hooks</span><span class="w"> </span><span class="kn">import</span> <span class="n">support_hooks</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">hook</span>


<span class="nd">@support_hooks</span>  <span class="c1"># enabling hook mechanism for the class</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

    <span class="c1"># this is slot</span>
    <span class="nd">@slot</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="nd">@MyClass</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">bind</span>  <span class="c1"># bound hook to the slot</span>
<span class="nd">@hook</span>  <span class="c1"># this is hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>  <span class="c1"># this is callback</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>


<span class="n">obj</span> <span class="o">=</span> <span class="n">MyClass</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">obj</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># will call callback(obj, 1)</span>

<span class="c1"># prints &quot;1 2&quot;</span>
</code></pre></div>
<h4 id="define-a-slot">Define a slot<a class="headerlink" href="#define-a-slot" title="Permanent link">&para;</a></h4>
<ul>
<li>Create a class with a method:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">arg</span>
</code></pre></div>
<ul>
<li>Add {ref}<code>slot-decorator</code> to the method:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">onetl.hooks</span><span class="w"> </span><span class="kn">import</span> <span class="n">support_hooks</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">hook</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">:</span>
    <span class="nd">@slot</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">arg</span>
</code></pre></div>
<p>If method has other decorators like <code>@classmethod</code> or <code>@staticmethod</code>, <code>@slot</code> should be placed on the top:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">onetl.hooks</span><span class="w"> </span><span class="kn">import</span> <span class="n">support_hooks</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">hook</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">:</span>
    <span class="nd">@slot</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">class_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">arg</span>

    <span class="nd">@slot</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">static_method</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">arg</span>
</code></pre></div>
<ul>
<li>Add {ref}<code>support-hooks-decorator</code> to the class:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">onetl.hooks</span><span class="w"> </span><span class="kn">import</span> <span class="n">support_hooks</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">hook</span>


<span class="nd">@support_hooks</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">:</span>
    <span class="nd">@slot</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">arg</span>
</code></pre></div>
<p>Slot is created.</p>
<h4 id="define-a-callback">Define a callback<a class="headerlink" href="#define-a-callback" title="Permanent link">&para;</a></h4>
<p>Define some function (a.k.a callback):</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</code></pre></div>
<p>It should have signature <em>compatible</em> with <code>MyClass.method</code>. <em>Compatible</em> does not mean <em>exactly the same</em> -
for example, you can rename positional arguments:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</code></pre></div>
<p>Use <code>*args</code> and <code>**kwargs</code> to omit arguments you don't care about:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
<p>There is also an argument <code>method_name</code> which has a special meaning -
the method name which the callback is bound to is passed into this argument:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">method_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>.. note::

    ``method_name`` should always be a keyword argument, **NOT** positional.
</code></pre></div>
<div class="highlight"><pre><span></span><code>.. warning::

    If callback signature is not compatible with slot signature, an exception will be raised,
    but **ONLY** while slot is called.
</code></pre></div>
<h4 id="define-a-hook">Define a hook<a class="headerlink" href="#define-a-hook" title="Permanent link">&para;</a></h4>
<p>Add {ref}<code>hook-decorator</code> to create a hook from your callback:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</code></pre></div>
<p>You can pass more options to the <code>@hook</code> decorator, like state or priority.
See decorator documentation for more details.</p>
<h4 id="bind-hook-to-the-slot">Bind hook to the slot<a class="headerlink" href="#bind-hook-to-the-slot" title="Permanent link">&para;</a></h4>
<p>Use <code>Slot.bind</code> method to bind hook to the slot:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@MyClass</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">bind</span>
<span class="nd">@hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</code></pre></div>
<p>You can bind more than one hook to the same slot, and bind same hook to multiple slots:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@MyClass</span><span class="o">.</span><span class="n">method1</span><span class="o">.</span><span class="n">bind</span>
<span class="nd">@MyClass</span><span class="o">.</span><span class="n">method2</span><span class="o">.</span><span class="n">bind</span>
<span class="nd">@hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">callback1</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="s2">&quot;Will be called by both MyClass.method1 and MyClass.method2&quot;</span>


<span class="nd">@MyClass</span><span class="o">.</span><span class="n">method1</span><span class="o">.</span><span class="n">bind</span>
<span class="nd">@hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">callback2</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="s2">&quot;Will be called by MyClass.method1 too&quot;</span>
</code></pre></div>
<h2 id="how-hooks-are-called">How hooks are called?<a class="headerlink" href="#how-hooks-are-called" title="Permanent link">&para;</a></h2>
<h3 id="general">General<a class="headerlink" href="#general" title="Permanent link">&para;</a></h3>
<p>Just call the method decorated by <code>@slot</code> to trigger the hook:</p>
<div class="highlight"><pre><span></span><code><span class="n">obj</span> <span class="o">=</span> <span class="n">MyClass</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">obj</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># will call callback(obj, 2)</span>

<span class="c1"># prints &quot;1 2&quot;</span>
</code></pre></div>
<p>There are some special callback types that has a slightly different behavior.</p>
<h3 id="context-managers">Context managers<a class="headerlink" href="#context-managers" title="Permanent link">&para;</a></h3>
<p><code>@hook</code> decorator can be placed on a context manager class:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@hook</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ContextManager</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># do something on enter</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="c1"># do something on exit</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
<p>Context manager is entered while calling the <code>Slot()</code>, and exited then the call is finished.</p>
<p>If present, method <code>process_result</code> has a special meaning -
it can receive <code>MyClass.method</code> call result, and also modify/replace it:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@hook</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ContextManager</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># do something on enter</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="c1"># do something on exit</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="c1"># do something with method call result</span>
        <span class="k">return</span> <span class="n">modified</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<p>See examples below for more information.</p>
<h3 id="generator-function">Generator function<a class="headerlink" href="#generator-function" title="Permanent link">&para;</a></h3>
<p><code>@hook</code> decorator can be placed on a generator function:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
    <span class="c1"># this is called before original method body</span>

    <span class="k">yield</span>  <span class="c1"># method is called here</span>

    <span class="c1"># this is called after original method body</span>
</code></pre></div>
<p>It is converted to a context manager, in the same manner as
<a href="https://docs.python.org/3/library/contextlib.html#contextlib.contextmanager">contextlib.contextmanager</a>.</p>
<p>Generator body can be wrapped with <code>try..except..finally</code> to catch exceptions:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># this is called before original method body</span>

        <span class="k">yield</span>  <span class="c1"># method is called here</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">process_exception</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># this is called after original method body</span>
        <span class="n">finalizer</span><span class="p">()</span>
</code></pre></div>
<p>There is also a special syntax which allows generator to access and modify/replace method call result:</p>
<div class="highlight"><pre><span></span><code>@hook
def callback(obj, arg):
    original_result = yield  # method is called here

    new_result = do_something(original_result)

    yield new_result  # modify/replace the result
</code></pre></div>
<h3 id="calling-hooks-in-details">Calling hooks in details<a class="headerlink" href="#calling-hooks-in-details" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>The callback will be called with the same arguments as the original method.</p>
</li>
<li>
<p>If slot is a regular method:</p>
<div class="highlight"><pre><span></span><code><span class="n">callback_result</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
<p>Here <code>self</code> is a class instance (<code>obj</code>).</p>
</li>
<li>
<p>If slot is a class method:</p>
<div class="highlight"><pre><span></span><code><span class="n">callback_result</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
<p>Here <code>cls</code> is the class itself (<code>MyClass</code>).</p>
</li>
<li>
<p>If slot is a static method:</p>
<div class="highlight"><pre><span></span><code><span class="n">callback_result</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
<p>Neither object not class are passed to the callback in this case.</p>
</li>
<li>
<p>If <code>callback_result</code> is a context manager, enter the context. Context manager can catch all the exceptions raised.</p>
</li>
</ul>
<blockquote>
<p>If there are multiple hooks bound the the slot, every context manager will be entered.</p>
</blockquote>
<ul>
<li>Then call the original method wrapped by <code>@slot</code>:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">original_result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>
<p>Process <code>original_result</code>:</p>
</li>
<li>
<p>If <code>callback_result</code> object has method <code>process_result</code>, or is a generator wrapped with <code>@hook</code>, call it:</p>
<div class="highlight"><pre><span></span><code><span class="n">new_result</span> <span class="o">=</span> <span class="n">callback_result</span><span class="o">.</span><span class="n">process_result</span><span class="p">(</span><span class="n">original_result</span><span class="p">)</span>
</code></pre></div>
</li>
<li>
<p>Otherwise set <code>new_result = callback_result</code>.</p>
</li>
<li>
<p>If there are multiple hooks bound the the method, pass <code>new_result</code> through the chain:</p>
<div class="highlight"><pre><span></span><code><span class="n">new_result</span> <span class="o">=</span> <span class="n">callback1_result</span><span class="o">.</span><span class="n">process_result</span><span class="p">(</span><span class="n">original_result</span><span class="p">)</span>
<span class="n">new_result</span> <span class="o">=</span> <span class="n">callback2_result</span><span class="o">.</span><span class="n">process_result</span><span class="p">(</span><span class="n">new_result</span> <span class="ow">or</span> <span class="n">original_result</span><span class="p">)</span>
<span class="n">new_result</span> <span class="o">=</span> <span class="n">callback3_result</span><span class="o">.</span><span class="n">process_result</span><span class="p">(</span><span class="n">new_result</span> <span class="ow">or</span> <span class="n">original_result</span><span class="p">)</span>
</code></pre></div>
</li>
<li>
<p>Finally return:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="n">new_result</span> <span class="ow">or</span> <span class="n">original_result</span>
</code></pre></div>
<p>All <code>None</code> values are ignored on every step above.</p>
<ul>
<li>Exit all the context managers entered during the slot call.</li>
</ul>
<h3 id="hooks-priority">Hooks priority<a class="headerlink" href="#hooks-priority" title="Permanent link">&para;</a></h3>
<p>Hooks are executed in the following order:</p>
<ol>
<li>Parent class slot + {obj}<code>FIRST &lt;onetl.hooks.hook.HookPriority.FIRST&gt;</code></li>
<li>Inherited class slot + {obj}<code>FIRST &lt;onetl.hooks.hook.HookPriority.FIRST&gt;</code></li>
<li>Parent class slot + {obj}<code>NORMAL &lt;onetl.hooks.hook.HookPriority.NORMAL&gt;</code></li>
<li>Inherited class slot + {obj}<code>NORMAL &lt;onetl.hooks.hook.HookPriority.NORMAL&gt;</code></li>
<li>Parent class slot + {obj}<code>LAST &lt;onetl.hooks.hook.HookPriority.LAST&gt;</code></li>
<li>Inherited class slot + {obj}<code>LAST &lt;onetl.hooks.hook.HookPriority.LAST&gt;</code></li>
</ol>
<p>Hooks with the same priority and inheritance will be executed in the same order they were registered (<code>Slot.bind</code> call).</p>
<div class="highlight"><pre><span></span><code>.. note::

    Calls of ``super()`` inside inherited class methods does not trigger hooks call.
    Hooks are triggered only if method is called explicitly.

    This allow to wrap with a hook the entire slot call without influencing its internal logic.
</code></pre></div>
<h3 id="hook-types">Hook types<a class="headerlink" href="#hook-types" title="Permanent link">&para;</a></h3>
<p>Here are several examples of using hooks. These types are not exceptional, they can be mixed - for example,
hook can both modify method result and catch exceptions.</p>
<h4 id="before-hook">Before hook<a class="headerlink" href="#before-hook" title="Permanent link">&para;</a></h4>
<p>Can be used for inspecting or validating input args of the original function:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">before1</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
    <span class="c1"># original method is called after exiting this function</span>


<span class="nd">@hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">before2</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;arg=1 is not allowed&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># return None is the same as no return statement</span>
</code></pre></div>
<p>Executed before calling the original method wrapped by <code>@slot</code>.
If hook raises an exception, method will not be called at all.</p>
<h4 id="after-hook">After hook<a class="headerlink" href="#after-hook" title="Permanent link">&para;</a></h4>
<p>Can be used for performing some actions after original method was successfully executed:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">after1</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">yield</span>  <span class="c1"># original method is called here</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>


<span class="nd">@hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">after2</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">yield</span> <span class="kc">None</span>  <span class="c1"># yielding None is the same as empty yield</span>
    <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;arg=1 is not allowed&quot;</span><span class="p">)</span>
</code></pre></div>
<p>If original method raises an exception, the block of code after <code>yield</code> will not be called.</p>
<h4 id="context-hook">Context hook<a class="headerlink" href="#context-hook" title="Permanent link">&para;</a></h4>
<p>Can be used for catching and handling some exceptions, or to determine that there was no exception during slot call:</p>
<div class="highlight"><pre><span></span><code>.. tabs::

  .. code-tab:: py Generator syntax

      # This is just the same as using @contextlib.contextmanager

      @hook
      def context_generator(obj, arg):
          try:
              yield  # original method is called here
              print(obj, arg)  # &lt;-- this line will not be called if method raised an exception
          except SomeException as e:
              magic(e)
          finally:
              finalizer()

  .. code-tab:: py Context manager syntax

      @hook
      class ContextManager:
          def __init__(self, obj, args):
              self.obj = obj
              self.args = args

          def __enter__(self):
              return self

          # original method is called between __enter__ and __exit__

          def __exit__(self, exc_type, exc_value, traceback):
              result = False
              if exc_type is not None and isinstance(exc_value, SomeException):
                  magic(exc_value)
                  result = True  # suppress exception
              else:
                  print(self.obj, self.arg)
              finalizer()
              return result
</code></pre></div>
<div class="highlight"><pre><span></span><code>.. note::

    Contexts are exited in the reverse order of the hook calls.
    So if some hook raised an exception, it will be passed into the previous hook, not the next one.

    It is recommended to specify the proper priority for the hook, e.g. :obj:`FIRST &lt;onetl.hooks.hook.HookPriority.FIRST&gt;`
</code></pre></div>
<h4 id="replacing-result-hook">Replacing result hook<a class="headerlink" href="#replacing-result-hook" title="Permanent link">&para;</a></h4>
<p>Replaces the output result of the original method.</p>
<p>Can be used for delegating some implementation details for third-party extensions.
See {ref}<code>hive</code> and {ref}<code>hdfs</code> as an example.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">replace1</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">+</span> <span class="mi">10</span>  <span class="c1"># any non-None return result</span>

    <span class="c1"># original method call result is ignored, output will always be arg + 10</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="nd">@hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">replace2</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">yield</span> <span class="n">arg</span> <span class="o">+</span> <span class="mi">10</span>  <span class="c1"># same as above</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>.. note::

    If there are multiple hooks bound to the same slot, the result of last hook will be used.
    It is recommended to specify the proper priority for the hook, e.g. :obj:`LAST &lt;onetl.hooks.hook.HookPriority.LAST&gt;`
</code></pre></div>
<h4 id="accessing-result-hook">Accessing result hook<a class="headerlink" href="#accessing-result-hook" title="Permanent link">&para;</a></h4>
<p>Can access output result of the original method and inspect or validate it:</p>
<div class="highlight"><pre><span></span><code>.. tabs::

    .. code-tab:: py Generator syntax

        @hook
        def access_result(obj, arg):
            result = yield  # original method is called here, and result can be used in the hook
            print(result)
            yield  # does not modify result

    .. code-tab:: py Context manager syntax

        @hook
        class ModifiesResult:
            def __init__(self, obj, args):
                self.obj = obj
                self.args = args

            def __enter__(self):
                return self

            # original method is called between __enter__ and __exit__
            # result is passed into process_result method of context manager, if present

            def process_result(self, result):
                print(result)  # result can be used in the hook
                return None  # does not modify result. same as no return statement in the method

            def __exit__(self, exc_type, exc_value, traceback):
                return False
</code></pre></div>
<h4 id="modifying-result-hook">Modifying result hook<a class="headerlink" href="#modifying-result-hook" title="Permanent link">&para;</a></h4>
<p>Can access output result of the original method, and return the modified one:</p>
<div class="highlight"><pre><span></span><code>.. tabs::

    .. code-tab:: py Generator syntax

        @hook
        def modifies_result(obj, arg):
            result = yield  # original method is called here, and result can be used in the hook
            yield result + 10  # modify output result. None values are ignored

    .. code-tab:: py Context manager syntax

        @hook
        class ModifiesResult:
            def __init__(self, obj, args):
                self.obj = obj
                self.args = args

            def __enter__(self):
                return self

            # original method is called between __enter__ and __exit__
            # result is passed into process_result method of context manager, if present

            def process_result(self, result):
                print(result)  # result can be used in the hook
                return result + 10  # modify output result. None values are ignored

            def __exit__(self, exc_type, exc_value, traceback):
                return False
</code></pre></div>
<div class="highlight"><pre><span></span><code>.. note::

    If there are multiple hooks bound to the same slot, the result of last hook will be used.
    It is recommended to specify the proper priority for the hook, e.g. :obj:`LAST &lt;onetl.hooks.hook.HookPriority.LAST&gt;`
</code></pre></div>
<h2 id="how-to-enabledisable-hooks">How to enable/disable hooks?<a class="headerlink" href="#how-to-enabledisable-hooks" title="Permanent link">&para;</a></h2>
<p>You can enable/disable/temporary disable hooks on 4 different levels:</p>
<ul>
<li>Manage global hooks state (level 1):</li>
</ul>
<blockquote>
<ul>
<li>{obj}<code>onetl.hooks.hooks_state.stop_all_hooks</code></li>
<li>{obj}<code>onetl.hooks.hooks_state.resume_all_hooks</code></li>
<li>{obj}<code>onetl.hooks.hooks_state.skip_all_hooks</code></li>
</ul>
</blockquote>
<ul>
<li>Manage all hooks bound to a specific class (level 2):</li>
</ul>
<blockquote>
<ul>
<li>{obj}<code>onetl.hooks.support_hooks.suspend_hooks</code></li>
<li>{obj}<code>onetl.hooks.support_hooks.resume_hooks</code></li>
<li>{obj}<code>onetl.hooks.support_hooks.skip_hooks</code></li>
</ul>
</blockquote>
<ul>
<li>Manage all hooks bound to a specific slot (level 3):</li>
</ul>
<blockquote>
<ul>
<li>{obj}<code>onetl.hooks.slot.Slot.suspend_hooks</code></li>
<li>{obj}<code>onetl.hooks.slot.Slot.resume_hooks</code></li>
<li>{obj}<code>onetl.hooks.slot.Slot.skip_hooks</code></li>
</ul>
</blockquote>
<ul>
<li>Manage state of a specific hook (level 4):</li>
</ul>
<blockquote>
<ul>
<li>{obj}<code>onetl.hooks.hook.Hook.enable</code></li>
<li>{obj}<code>onetl.hooks.hook.Hook.disable</code></li>
</ul>
</blockquote>
<p>More details in the documentation above.</p>
<div class="highlight"><pre><span></span><code>.. note::

    All of these levels are independent.

    Calling ``stop`` on the level 1 has higher priority than level 2, and so on.
    But calling ``resume`` on the level 1 does not automatically resume hooks stopped in the level 2,
    they should be resumed explicitly.
</code></pre></div>
<h2 id="how-to-see-logs-of-the-hook-mechanism">How to see logs of the hook mechanism?<a class="headerlink" href="#how-to-see-logs-of-the-hook-mechanism" title="Permanent link">&para;</a></h2>
<p>Hooks registration emits logs with <code>DEBUG</code> level:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">onetl.logs</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_logging</span>

<span class="n">setup_logging</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>DEBUG  |onETL| Registered hook &#39;mymodule.callback1&#39; for &#39;MyClass.method&#39; (enabled=True, priority=HookPriority.NORMAL)
DEBUG  |onETL| Registered hook &#39;mymodule.callback2&#39; for &#39;MyClass.method&#39; (enabled=True, priority=HookPriority.NORMAL)
DEBUG  |onETL| Registered hook &#39;mymodule.callback3&#39; for &#39;MyClass.method&#39; (enabled=False, priority=HookPriority.NORMAL)
</code></pre></div>
<p>But most of logs are emitted with even lower level <code>NOTICE</code>, to make output less verbose:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">onetl.logs</span><span class="w"> </span><span class="kn">import</span> <span class="n">NOTICE</span><span class="p">,</span> <span class="n">setup_logging</span>

<span class="n">setup_logging</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">NOTICE</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>NOTICE  |Hooks| 2 hooks registered for &#39;MyClass.method&#39;
NOTICE  |Hooks| Calling hook &#39;mymodule.callback1&#39; (1/2)
NOTICE  |Hooks| Hook is finished with returning non-None result
NOTICE  |Hooks| Calling hook &#39;mymodule.callback2&#39; (2/2)
NOTICE  |Hooks| This is a context manager, entering ...
NOTICE  |Hooks|   Calling original method &#39;MyClass.method&#39;
NOTICE  |Hooks|   Method call is finished
NOTICE  |Hooks| Method call result (*NOT* None) will be replaced with result of hook &#39;mymodule.callback1&#39;
NOTICE  |Hooks|   Passing result to &#39;process_result&#39; method of context manager &#39;mymodule.callback2&#39;
NOTICE  |Hooks|   Method call result (*NOT* None) is modified by hook!
</code></pre></div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.indexes", "content.tabs.link", "content.code.copy", "content.code.select"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../../assets/mkdocs_puml/puml.js"></script>
      
        <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
      
        <script src="../../assets/mkdocs_puml/interaction.js"></script>
      
    
  </body>
</html>