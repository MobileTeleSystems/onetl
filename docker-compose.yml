version: '3.9'

# NOTE: local development only
services:
  onetl:
    image: mtsrus/onetl:develop
    build:
      dockerfile: ./docker/Dockerfile
      context: .
      target: base
      args:
        SPARK_VERSION: 3.3.2
    env_file: .env.docker
    volumes:
    - ./:/app/
    networks:
    - onetl
    - default
    ulimits:
      # https://stackoverflow.com/a/56895801
      nofile:
        soft: 10000
        hard: 10000
    # no dependencies from other containers to allow running limited set of tests instead of all


  mongodb:
    image: ${MONGODB_IMAGE:-mongo:latest}
    restart: unless-stopped
    ports:
    - 27017:27017
    env_file: .env.dependencies
    networks:
    - onetl

  minio:
    image: ${MINIO_IMAGE:-bitnami/minio:latest}
    restart: unless-stopped
    env_file: .env.dependencies
    ports:
    - 9010:9000
    - 9011:9001
    networks:
    - onetl

  postgres:
    image: ${POSTGRES_IMAGE:-postgres:15.2}
    restart: unless-stopped
    env_file: .env.dependencies
    ports:
    - 5432:5432
    networks:
    - onetl

  greenplum:
    image: ${GREENPLUM_IMAGE:-datagrip/greenplum:6.8}
    restart: unless-stopped
    env_file: .env.dependencies
    ports:
    - 5433:5432
    networks:
    - onetl

  hdfs:
    image: ${HDFS_IMAGE:-mtsrus/hadoop:hadoop2-hdfs}
    hostname: hdfs
    restart: unless-stopped
    env_file: .env.dependencies
    ports:
    - 9820:9820  # HDFS IPC
    - 9870:9870  # WebHDFS
    - 9864:9864  # Datanode UI
    volumes:
    - ./docker/hdfs/conf/hadoop/:/var/hadoop/conf/
    networks:
    - onetl

  oracle:
    image: ${ORACLE_IMAGE:-gvenzl/oracle-xe:21.3.0-faststart}
    restart: unless-stopped
    env_file: .env.dependencies
    ports:
    - 1522:1521
    networks:
    - onetl

  webdav:
    image: docker.rep.msk.mts.ru/bigdata/platform/onetools/onetl/webdav:develop
    build:
      dockerfile: ./docker/webdav/Dockerfile
      context: .
    hostname: webdav
    restart: unless-stopped
    env_file: .env.dependencies
    ports:
    - 8000:80
    - 8443:443
    networks:
    - onetl

  clickhouse:
    image: ${CLICKHOUSE_IMAGE:-clickhouse/clickhouse-server:latest}
    restart: unless-stopped
    ports:
    - 8123:8123
    - 9001:9000
    networks:
    - onetl

  mysql:
    image: ${MYSQL_IMAGE:-mysql:latest}
    restart: unless-stopped
    env_file: .env.dependencies
    ports:
    - 3306:3306
    networks:
    - onetl

  mssql:
    image: ${MSSQL_IMAGE:-mcmoe/mssqldocker:latest}
    restart: unless-stopped
    env_file: .env.dependencies
    ports:
    - 1433:1433
    networks:
    - onetl

  sftp:
    image: ${SFTP_IMAGE:-linuxserver/openssh-server}
    restart: unless-stopped
    env_file: .env.dependencies
    ports:
    - 2222:2222
    networks:
    - onetl

networks:
  onetl:
